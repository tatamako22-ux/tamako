<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TAMAKO | Registro Demo</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root{ --gold:#bf953f; }

*{margin:0;padding:0;box-sizing:border-box;}

body{
    margin:0;
    font-family: 'Inter', sans-serif;
    background:
    radial-gradient(circle at 70% 30%, rgba(255,190,60,0.25), transparent 40%),
    radial-gradient(circle at 30% 70%, rgba(255,190,60,0.15), transparent 40%),
    linear-gradient(180deg, #050505 0%, #0a0a0f 100%);
    color:#ffffff;
    overflow-x:hidden;
}

body::before{
    content:"";
    position:fixed;
    inset:0;
    background:
        radial-gradient(circle at 50% 50%, rgba(191,149,63,0.12), transparent 55%);
    z-index:-1;
}

body::after{
    content:"";
    position:fixed;
    top:0;
    left:-50%;
    width:200%;
    height:100%;
    background:linear-gradient(
        120deg,
        transparent 40%,
        rgba(191,149,63,0.05),
        transparent 60%
    );
    animation: moveGlow 8s linear infinite;
    pointer-events:none;
    z-index:-1;
}

@keyframes moveGlow{
    from{ transform:translateX(0); }
    to{ transform:translateX(50%); }
}
.background {
    position: fixed;
    inset: 0;
    z-index: -2;
    background: 
        radial-gradient(circle at 20% 30%, rgba(191, 149, 63, 0.15), transparent 40%),
        radial-gradient(circle at 80% 70%, rgba(191, 149, 63, 0.1), transparent 40%),
        black;
}
/* A√±adimos un efecto de estrellas/part√≠culas sutil */
.background::after {
    content: "";
    position: absolute;
    inset: 0;
    background-image: radial-gradient(rgba(191,149,63,0.3) 1px, transparent 1px);
    background-size: 50px 50px;
    opacity: 0.2;
}
.frame{
    position:fixed;
    inset:40px;
    border:1.5px solid rgba(191,149,63,.4);
    pointer-events:none;
}

@media (max-height:800px){
    .frame{
        display:none; /* üëà evita que rompa en pantallas bajas */
    }
}

.register-card {
    width: 480px;
    max-height: 90vh;
    max-width: 95%;
    position: relative;
    padding: 30px 40px; /* Reducimos el padding vertical */
    height: fit-content; /* Se ajusta estrictamente al contenido */
    margin: auto;
    background: rgba(15, 15, 15, 0.9);
    backdrop-filter: blur(20px);
    border-radius: 25px;
    border: 1px solid rgba(191, 149, 63, 0.3);
    box-shadow: 0 20px 50px rgba(0,0,0,0.9);
    display: block; /* Asegura que no se comporte como flex hijo */
}
.register-card:hover {
    transform: translateY(-5px) scale(1.01);
}
.register-card h1{
    font-family:'Cinzel',serif;
    letter-spacing:6px;
    color:var(--gold);
    margin-bottom:10px;
    font-size:1.4rem;
}

.register-card p {
    font-size: .8rem;
    color: #bbb;
    margin-bottom: 20px; /* Menos espacio aqu√≠ */
    letter-spacing: 1px;
}
.form-title{
    grid-column:span 2;
    text-align:center;
    font-family:'Cinzel',serif;
    font-size:1.2rem;
    letter-spacing:4px;
    color:var(--gold);
    margin-bottom:8px;
}

.form-subtitle{
    grid-column:span 2;
    text-align:center;
    font-size:.8rem;
    color:#9a9a9a;
    margin-bottom:20px;
}
form {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px; /* Reducimos el espacio entre campos */
    margin-top: 10px;
}

.form-group input {
    width: 100%;
    padding: 10px 14px; /* Inputs un poco m√°s delgados */
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(191, 149, 63, 0.2);
    border-radius: 10px;
    color: #fff;
    font-size: 0.85rem;
}

.form-group input {
    width: 100%;
    padding: 10px 5px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(191, 149, 63, 0.2);
    border-radius: 15px;
    color: #fff;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
}
.form-group input:focus {
    background: rgba(255, 255, 255, 0.07);
    border-color: #fcf6ba;
    outline: none;
    box-shadow: 0 0 15px rgba(191, 149, 63, 0.3);
}
.form-group input::placeholder{
    color:rgba(255,255,255,.55);
    font-weight:300;
}
.btn-register {
    width: 100%;
    padding: 13px;
    background: linear-gradient(135deg, #bf953f 0%, #fcf6ba 50%, #aa771c 100%);
    border: none;
    border-radius: 50px;
    color: #1a1a1a;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 3px;
    font-size: 0.85rem;
    cursor: pointer;
    box-shadow: 0 10px 20px rgba(0,0,0,0.4);
    transition: all 0.4s ease;
}
.btn-register:hover{
    background:var(--gold);
    color:black;
    transform:translateY(-3px);
    box-shadow:0 10px 20px rgba(191,149,63,.3);
}

.btn-register:hover{
    background:var(--gold);
    color:black;
    transform:translateY(-3px);
    box-shadow:0 10px 20px rgba(191,149,63,.3);
}

.login-link {
    font-size: .75rem;
    color: #888;
}

.login-link a{
    color:var(--gold);
    text-decoration:none;
}
.layout {
    width: 100%;
    max-width: 1100px;
    height: auto;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 60px;
}
.branding {
    flex: 0 1 45%;
    padding: 0px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    text-align: left;
    animation: fadeUp 1.2s ease forwards;
}

.logo {
    font-family: 'Cinzel', serif;
    font-size: 4.5rem;
    letter-spacing: 15px;
    background: linear-gradient(to right, #bf953f 20%, #fcf6ba 40%, #fcf6ba 60%, #bf953f 80%);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shine 4s linear infinite;
    margin-bottom: 20px;
    filter: drop-shadow(0 0 10px rgba(191,149,63,0.3));
}

@keyframes shine {
    to { background-position: 200% center; }
}

.tagline{
    color:#aaa;
    font-size:1.05rem;
    max-width:360px;
    line-height:1.8;
    letter-spacing:1px;
}

.modal{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.55);
    backdrop-filter: blur(8px);
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    pointer-events: none;
    transition: .4s ease;
}
.modal::before{
    content:"";
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%);
    width:600px;
    height:600px;
    background:radial-gradient(circle, rgba(191,149,63,.18), transparent 70%);
    z-index:-1;
}
.modal.show{
    opacity:1;
    pointer-events:auto;
}

.modal-content{
    background:linear-gradient(145deg, rgba(255,255,255,0.06), rgba(0,0,0,0.4));
    backdrop-filter:blur(25px);
    border:1px solid rgba(191,149,63,.35);
    border-radius:28px;
    padding:45px 35px;
    text-align:center;
    width:90%;
    max-width:420px;
    box-shadow:
        0 25px 60px rgba(0,0,0,.7),
        0 0 40px rgba(191,149,63,.15);
    animation:scaleIn .35s ease;
    position:relative;
}
#otpCode{
    width:100%;
    padding:16px 20px;
    margin-bottom:20px;
    border-radius:50px;
    border:1px solid rgba(191,149,63,.35);
    background:rgba(255,255,255,0.05);
    color:white;
    font-size:1rem;
    text-align:center;
    letter-spacing:4px;
    outline:none;
    transition:.3s;
}

#otpCode:focus{
    border-color:var(--gold);
    box-shadow:0 0 15px rgba(191,149,63,.3);
}
.modal-content h2{
    font-family:'Cinzel',serif;
    color:var(--gold);
    margin-bottom:15px;
    letter-spacing:2px;
}

.modal-content p{
    color:#aaa;
    margin-bottom:30px;
    font-size:.9rem;
}

@keyframes scaleIn{
    from{transform:scale(.8); opacity:0;}
    to{transform:scale(1); opacity:1;}
}
@keyframes fadeUp{
    from{
        opacity:0;
        transform:translateY(40px);
    }
    to{
        opacity:1;
        transform:translateY(0);
    }
}
.input-error{
    border-color:#ff4d4d !important;
    box-shadow:0 0 10px rgba(255,77,77,.4);
}
/* ============================= */
/* ===== RESPONSIVE TAMAKO ===== */
/* ============================= */

@media (max-width: 900px) {

    body {
        flex-direction: column;
    }

    .sidebar {
        width: 100%;
        height: auto;
        position: relative;
        border-right: none;
        border-bottom: 1px solid rgba(191, 149, 63, 0.2);
        padding: 20px;
    }

    .main-content {
        padding: 25px;
    }

}
.tamako-toast{
    position: fixed;
    top: 30px;
    right: 30px;
    background: linear-gradient(135deg,#1a1a1a,#000);
    border: 1px solid #bf953f;
    color: #fff;
    padding: 14px 22px;
    border-radius: 10px;
    font-size: .85rem;
    opacity: 0;
    transform: translateY(-10px);
    transition: all .4s ease;
    z-index: 9999;
    box-shadow: 0 0 20px rgba(191,149,63,.4);
}

.tamako-toast.show{
    opacity: 1;
    transform: translateY(0);
}
</style>
</head>
<body>

<div class="background"></div>
<div class="frame"></div>

<div class="layout">

    <div class="branding">
        <h1 class="logo">TAMAKO</h1>
        <p class="tagline">Sistema inteligente para negocios premium</p>
    </div>

    <div class="register-card">

    <form id="registerForm">
        <h1 class="form-title">PRUEBA DEMO</h1>
        <p style="grid-column:span 2; margin-bottom:20px;">Crea tu cuenta gratuita por 7 d√≠as</p>

        <div class="form-group">
            <input type="text" id="nombre_tienda" placeholder="Nombre del Negocio" required>
        </div>

        <div class="form-group">
            <input type="text" id="propietario" placeholder="Propietario" required>
        </div>

        <div class="form-group">
            <input type="tel" id="telefono" placeholder="Tel√©fono" required maxlength="10" pattern="[0-9]{10}">
            <small id="phoneError" style="color:#ff4d4d; display:none; grid-column:span 2; font-size:.75rem; text-align:left;">
                El tel√©fono debe tener exactamente 10 d√≠gitos
            </small>
        </div>

        <div class="form-group">
            <input type="text" id="direccion" placeholder="Direcci√≥n" required>
        </div>

        <div class="form-group">
            <input type="number" id="cantidad_puestos" placeholder="Cantidad de Puestos" required>
        </div>

        <div class="form-group">
            <input type="email" id="email" placeholder="Correo Electr√≥nico" required>
        </div>

        <div class="form-group">
            <input type="password" id="password" placeholder="Contrase√±a" required>
        </div>
        
        <div class="form-group">
            <input type="password" id="confirmPassword" placeholder="Confirmar Contrase√±a" required>
        </div>

        <small id="passwordError" style="color:#ff4d4d; display:none; grid-column:span 2; font-size:.75rem; text-align:left;">
            Las contrase√±as no coinciden
        </small>

        <button type="submit" class="btn-register" id="createBtn" style="grid-column:span 2;">
            <span id="btnText">CREAR DEMO</span>
        </button>
        <div class="login-link" style="grid-column: span 2; text-align:center; margin-top:15px;">
    ¬øYa tienes cuenta? <a href="login.html">Iniciar sesi√≥n</a>
</div>

    </form>
    <!-- üî• MODAL OTP -->
    <div id="otpModal" class="modal">
        <div class="modal-content">
            <h2>Verifica tu correo üì©</h2>
            <p>Te enviamos un c√≥digo de 8 d√≠gitos a tu email.</p>

            <input type="text" id="otpCode" placeholder="Ingresa el c√≥digo de 8 d√≠gitos" maxlength="8">
            <button type="button" id="verifyOtp" class="btn-register">
                VERIFICAR C√ìDIGO
            </button>

            <p style="margin-top:15px; font-size:.8rem; color:#aaa;">
                ¬øNo recibiste el c√≥digo?
            </p>

            <button type="button" id="resendOtp" 
                style="background:none;border:none;color:#bf953f;cursor:pointer;font-size:.85rem;margin-top:5px;">
                Reenviar c√≥digo
            </button>
        </div>
    </div>

    <!-- üî• MODAL √âXITO -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <h2>Cuenta creada exitosamente ‚ú®</h2>
            <p>Tu negocio ya est√° listo para comenzar.</p>
            <button id="goDashboard" class="btn-register">
                ACCEDER AL SISTEMA
            </button>
        </div>
    </div>
</div>

<!-- 1Ô∏è‚É£ Cargar Supabase -->
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const supabaseUrl = "https://smibbddmwgdmqpwsuaqr.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNtaWJiZGRtd2dkbXFwd3N1YXFyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzODc1NzYsImV4cCI6MjA4NTk2MzU3Nn0.S3Z4m8s_nHa_reulKMFH1RtqoUgh9Cqzj69H0WTbghk";

const supabaseClient = createClient(supabaseUrl, supabaseKey);
// ==========================
// GENERAR SLUG AUTOM√ÅTICO
// ==========================
function generarSlug(nombre) {
  return nombre
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/\s+/g, "-")
    .replace(/[^\w-]+/g, "");
}
document.getElementById("registerForm").addEventListener("submit", async function(e){
    e.preventDefault();
    const submitButton = document.getElementById("createBtn");
    const btnText = document.getElementById("btnText");
    submitButton.disabled = true;
    btnText.innerText = "CREANDO...";
    submitButton.style.opacity = "0.7";
    submitButton.style.cursor = "not-allowed";
    const password = document.getElementById("password").value;
    const confirmPassword = document.getElementById("confirmPassword").value;

    const errorText = document.getElementById("passwordError");
    const passwordInput = document.getElementById("password");
    const confirmInput = document.getElementById("confirmPassword");

    if(password !== confirmPassword){
        errorText.style.display = "block";

        passwordInput.classList.add("input-error");
        confirmInput.classList.add("input-error");
        submitButton.disabled = false;
        btnText.innerText = "CREAR DEMO";
        submitButton.style.opacity = "1";
        submitButton.style.cursor = "pointer";

        return;
    } else {
        errorText.style.display = "none";

        passwordInput.classList.remove("input-error");
        confirmInput.classList.remove("input-error");
    }
    // VALIDAR TEL√âFONO
        const phoneInput = document.getElementById("telefono");
        const phoneError = document.getElementById("phoneError");
        const phoneValue = phoneInput.value.trim();

        if(!/^\d{10}$/.test(phoneValue)){
        phoneError.style.display = "block";
        phoneInput.classList.add("input-error");
        submitButton.disabled = false;
        btnText.innerText = "CREAR DEMO";
        submitButton.style.opacity = "1";
        submitButton.style.cursor = "pointer";
        return;
        } else {
            phoneError.style.display = "none";
            phoneInput.classList.remove("input-error");
        }
        // REGISTRAR USUARIO EN SUPABASE
        const email = document.getElementById("email").value.trim().toLowerCase();
        const passwordValue = document.getElementById("password").value;

        const { error } = await supabaseClient.auth.signInWithOtp({
            email: email,
            options: {
                shouldCreateUser: true,
                emailOtpType: "numeric"   // üëà ESTA L√çNEA ES LA CLAVE
            }
        });

        if (error) {
            alert(error.message);
            submitButton.disabled = false;
            btnText.innerText = "CREAR DEMO";
            submitButton.style.opacity = "1";
            submitButton.style.cursor = "pointer";
            return;
        }
        document.getElementById("registerForm").style.display = "none";
        document.getElementById("otpModal").classList.add("show");

        setTimeout(() => {
            document.getElementById("otpCode").focus();
        }, 300);
        submitButton.disabled = false;
        btnText.innerText = "CREAR DEMO";
        submitButton.style.opacity = "1";
        submitButton.style.cursor = "pointer";
});
const passwordInput = document.getElementById("password");
const confirmInput = document.getElementById("confirmPassword");
const errorText = document.getElementById("passwordError");

function validatePasswords(){
    if(passwordInput.value === confirmInput.value){
        errorText.style.display = "none";
        passwordInput.classList.remove("input-error");
        confirmInput.classList.remove("input-error");
    }
}

passwordInput.addEventListener("input", validatePasswords);
confirmInput.addEventListener("input", validatePasswords);
// BLOQUEAR LETRAS EN TEL√âFONO
const phoneInput = document.getElementById("telefono");
const phoneError = document.getElementById("phoneError");

phoneInput.addEventListener("input", function(){
    this.value = this.value.replace(/\D/g, '');

    if(this.value.length === 10){
        phoneError.style.display = "none";
        this.classList.remove("input-error");
    }
});

    // ==========================
    // VERIFICAR C√ìDIGO OTP
    // ==========================
    document.getElementById("verifyOtp").addEventListener("click", async function(){
    const verifyBtn = document.getElementById("verifyOtp");
    verifyBtn.disabled = true;
    verifyBtn.innerText = "VERIFICANDO...";
    verifyBtn.style.opacity = "0.7";

    const code = document.getElementById("otpCode").value.trim();
    if(!/^\d{8}$/.test(code)){
    alert("Ingresa un c√≥digo v√°lido de 8 d√≠gitos");
    verifyBtn.disabled = false;
    verifyBtn.innerText = "VERIFICAR C√ìDIGO";
    verifyBtn.style.opacity = "1";
    return;
}
    const email = document.getElementById("email").value.trim();

    if(!email){
    alert("Primero debes registrarte con tu correo.");
    verifyBtn.disabled = false;
    verifyBtn.innerText = "VERIFICAR C√ìDIGO";
    verifyBtn.style.opacity = "1";
    return;
}

    const { data, error } = await supabaseClient.auth.verifyOtp({
    email: email,
    token: code,
    type: 'email'
});

    if(error){
    alert("C√≥digo incorrecto o vencido");
    verifyBtn.disabled = false;
    verifyBtn.innerText = "VERIFICAR C√ìDIGO";
    verifyBtn.style.opacity = "1";
    return;
}
// ==========================
// 1Ô∏è‚É£ OBTENER USUARIO AUTENTICADO
// ==========================
const { data: userData } = await supabaseClient.auth.getUser();
const user = userData.user;

if (!user) {
    alert("Error obteniendo usuario autenticado.");
    verifyBtn.disabled = false;
    verifyBtn.innerText = "VERIFICAR C√ìDIGO";
    verifyBtn.style.opacity = "1";
    return;
}

// ==========================
// 2Ô∏è‚É£ GENERAR SLUG
// ==========================
const nombreTienda = document.getElementById("nombre_tienda").value.trim();
const slug = generarSlug(nombreTienda);

// ==========================
// 3Ô∏è‚É£ CREAR TIENDA
// ==========================
const { data: tiendaInsertada, error: insertError } = await supabaseClient
    .from("tiendas")
    .insert([{
        nombre: nombreTienda,
        slug: slug,
        propietario: document.getElementById("propietario").value.trim(),
        telefono: document.getElementById("telefono").value.trim(),
        direccion: document.getElementById("direccion").value.trim(),
        cantidad_puestos: parseInt(document.getElementById("cantidad_puestos").value),
        email: document.getElementById("email").value.trim().toLowerCase()
    }])
    .select()
    .single();

if (insertError) {
    alert("Error al guardar la tienda: " + insertError.message);
    verifyBtn.disabled = false;
    verifyBtn.innerText = "VERIFICAR C√ìDIGO";
    verifyBtn.style.opacity = "1";
    return;
}

// ==========================
// 4Ô∏è‚É£ CREAR PERFIL ADMIN
// ==========================
const { error: perfilError } = await supabaseClient
    .from("perfiles")
    .insert([{
        user_id: user.id,
        tienda_id: tiendaInsertada.id,
        rol: "admin"
    }]);

if (perfilError) {
    alert("Error al crear perfil: " + perfilError.message);
    verifyBtn.disabled = false;
    verifyBtn.innerText = "VERIFICAR C√ìDIGO";
    verifyBtn.style.opacity = "1";
    return;
}
document.getElementById("otpModal").classList.remove("show");
document.getElementById("registerForm").style.opacity = "1";
document.getElementById("registerForm").style.display = "none";

const modal = document.getElementById("successModal");
modal.classList.add("show");

});
// ==========================
// REENVIAR C√ìDIGO OTP
// ==========================
document.getElementById("resendOtp").addEventListener("click", async function(){

    const resendBtn = document.getElementById("resendOtp");
    resendBtn.innerText = "Enviando...";
    resendBtn.disabled = true;

    const email = document.getElementById("email").value.trim().toLowerCase();

    const { error } = await supabaseClient.auth.signInWithOtp({
        email: email,
        options: {
            shouldCreateUser: true,
            emailOtpType: "numeric"
        }
    });

    if(error){

    showToast("Por seguridad debes esperar 45 segundos antes de reenviar el c√≥digo ‚è≥");

    resendBtn.innerText = "Reenviar c√≥digo";
    resendBtn.disabled = false;
    return;
}

    alert("Nuevo c√≥digo enviado üì©");
    resendBtn.innerText = "Reenviar c√≥digo";
    resendBtn.disabled = false;
});

// üëá AQU√ç DENTRO DEL SCRIPT
document.getElementById("goDashboard").addEventListener("click", function(){

    localStorage.setItem("tamakoSession", "active");

    window.location.href = "dashboard.html";
});
// ==========================
// TOAST FLOTANTE TAMAKO
// ==========================
function showToast(message){

    const toast = document.createElement("div");
    toast.className = "tamako-toast";
    toast.innerText = message;

    document.body.appendChild(toast);

    setTimeout(() => {
        toast.classList.add("show");
    }, 100);

    setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => toast.remove(), 400);
    }, 4000);
}
</script>
</body>
</html>